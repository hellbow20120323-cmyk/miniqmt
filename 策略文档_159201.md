# 159201 自由现金流 ETF 网格套利策略文档

> 版本：ATR 动态网格 + 趋势自适应 + 层数加成步长 + 动态冷静期 + 单笔止盈  
> 更新日期：2025-02

---

## 一、策略概述

本策略针对 **159201（自由现金流 ETF）**，采用 **T+0 日内网格套利**：价格下跌时分档买入（最多 9 层），单笔止盈或整体浮盈达阈值时平仓，赚取 Alpha。核心为 **ATR 动态网格 + 趋势自适应 + 层数加成网格步长 + 动态冷静期 + 单笔止盈**，并配备 **ATR 熔断** 与 **单周期最大浮亏止损**。手续费为 **万一**，步长下限覆盖实盘约 1 tick 滑点。

---

## 二、资金与仓位

| 参数 | 值 | 说明 |
|------|-----|------|
| 总资金（曲线基准） | 50 万 | 用于 Alpha 曲线与回撤计算 |
| 固定仓（Beta 底仓） | **30 万** | 严格 30 万底仓，Beta 收益按此计算 |
| 流动仓（单轮套利） | **20 万** | 单轮 T+0 最大投入，按权重分配到 9 层 |
| 最大补仓层数 | **9 层** | 每层金额由 LAYER_WEIGHTS 决定 |
| 最小交易单位 | 100 股 | 按 100 股整数倍下单 |
| 手续费 | **0.01%（万一）** | 买卖均扣，ETF 无印花税 |

### 层权与每层金额

- **当前回测**：`LAYER_WEIGHTS = (1,1,1,1,1,1,1,1,1)` 均权，每层约 20万/9 ≈ 2.22 万（再乘趋势 batch_factor）。
- **可选阶梯**：改为如 `(1, 1, 1.5, 1.5, 1.5, 1, 1, 1, 1)` 可前轻后重，长度须等于 `MAX_LAYERS`（9）。
- **每层金额**：第 k 层投入 = `BATCH_MONEY × (LAYER_WEIGHTS[k] / sum(LAYER_WEIGHTS)) × batch_factor`。

---

## 三、核心逻辑

### 3.1 执行顺序（重要）

每根 K 线按以下顺序判断，**有持仓时优先处理卖出与止损**：

1. **有持仓** → 先算浮亏；若 ≥ 单周期最大浮亏 → **强制平仓**；否则按**单笔止盈**判断是否卖出。
2. **无持仓或未触发卖出** → 若满足买入条件且未熔断、未在时间/**动态冷静期**内 → **加仓**（最多 9 层）。
3. **已满 9 层且价格仍触发买入** → 仅统计“想买但无子弹”的 K 线数，不执行买入。

### 3.2 买入条件

- **触发**：当前价 ≤ 上次买入价 × (1 - 网格步长 × 跌少系数)
- **限制**：当前层数 < 9 层，且 **未处于 ATR 熔断**，且未在时间过滤/**全平冷静期**内（若启用）
- **网格步长（含层数加成）**：  
  - 基础：`base_grid_step = max(GRID_STEP_FLOOR, (ATR14/当前价) × ATR_GRID_FACTOR)`，再按趋势系数调整。  
  - 最终：`grid_step = base_grid_step + (hold_layers × LAYER_STEP_BONUS)`，第 9 层比第 1 层多约 0.08% 安全距离。
- **每层金额**：`part_money_list[hold_layers] × batch_factor`
- **滚动锚点**：每次全量卖出后，以**卖出价**作为新一轮的“上次买入价”
- **动态冷静期**：全量平仓后禁止新开第一层；若当前 **RSI(14) < 35**（超跌）则冷静期**缩短为 5 分钟**，否则为 **15 分钟**，便于超跌反弹时更快二次进场

### 3.3 卖出条件

- **单笔止盈**（当前）：每笔持仓达到止盈比例（基准阈值 × 涨多系数）即全平该笔
- **强制止损**：本周期持仓浮亏 ≥ 单周期最大浮亏（元）→ 立即市价平仓
- **移动止盈**（已关闭）：可选启用时盈利率 0.4% 启动跟踪、从最高点回撤 0.08% 一次性清仓

### 3.4 趋势判断

- **指标**：1 分钟 MA60 的 5 周期变化率，再经 **3 周期 EMA 平滑**，减少参数频繁切换导致的交易混乱  
  `raw_slope = ma60.diff(5) / ma60.shift(5)`，`ma60_slope = raw_slope.ewm(span=3, adjust=False).mean()`
- **上升趋势**：slope > 0 → 放宽网格、提高止盈、缩小每档金额
- **下降趋势**：slope < 0 → 收紧网格、降低止盈、放大每档金额
- **中性**：slope = 0 → 基准参数

---

## 四、参数配置

### 4.1 网格与止盈（成本下调 + 覆盖增强）

| 参数 | 值 | 说明 |
|------|-----|------|
| ATR_PERIOD | 14 | ATR 计算周期 |
| ATR_GRID_FACTOR | **0.38** | 网格弹性系数 |
| GRID_STEP_FLOOR | **0.0012 (0.12%)** | 步长下限，覆盖实盘至少 1 tick 滑点损耗 |
| LAYER_STEP_BONUS | **0.0001** | 层数加成：每多一层步长 +0.01%，第 9 层比第 1 层多约 0.08% |
| SELL_PROFIT_THRESHOLD | 0.005 (0.5%) | 基准止盈阈值，再按趋势系数与层数自适应 |
| COMMISSION_RATE | **0.0001** | **万一**佣金 |

### 4.2 层权与资金

| 参数 | 当前值 | 说明 |
|------|--------|------|
| LAYER_WEIGHTS | (1,1,1,1,1,1,1,1,1) | 回测默认 9 层均权；可改为阶梯如 (1,1,1.5,1.5,1.5,1,1,1,1) |

### 4.3 趋势自适应系数

| 趋势 | 网格系数 | 止盈系数 | 仓位系数 | 效果 |
|------|----------|----------|----------|------|
| 上升 | 1.2 | 1.33 | 0.7 | 跌少买、涨多卖 |
| 下降 | 1.0 | 0.83 | 1.2 | 跌多买、涨少卖 |
| 中性 | 1.0 | 1.0 | 1.0 | 基准 |

### 4.4 自动化风控

| 参数 | 值 | 说明 |
|------|-----|------|
| ATR_CIRCUIT_BREAKER_ENABLED | True | 开启 ATR 熔断 |
| ATR_CIRCUIT_BREAKER_RATIO | **2.0** | 当前 ATR > 近期均值×2.0 时，本 K 线**不新开层** |
| ATR_LOOKBACK | 60 | 近期 ATR 取过去 60 根 K 线均值 |
| MAX_CYCLE_FLOAT_LOSS | **15,000 元** | 单周期持仓浮亏超过 1.5 万则强制平仓（针对 20 万流动仓） |

- 熔断仅限制**加仓**，不限制卖出与止损。  
- 有持仓时**先判断是否触发单周期浮亏止损**，再判断正常止盈，再考虑买入。

### 4.5 全平冷静期与可选功能

| 功能 | 参数 | 当前状态 | 说明 |
|------|------|----------|------|
| **动态冷静期** | COOLING_ENABLED / COOLING_BARS / COOLING_BARS_SHORT / RSI_COOLING_THRESHOLD | True / 15 / 5 / 35 | 全平后禁止新开第一层；RSI<35 时 5 分钟，否则 15 分钟 |
| 移动止盈 | TRAILING_ENABLED | **False**（已关闭） | 可选：0.4% 启动跟踪、0.08% 回撤清仓 |
| 时间过滤 | TIME_FILTER_ENABLED | False | 若 True：9:30–9:45 不新开第一层，14:45 后只卖不买 |
| 多周期共振 | MTF_ENABLED | False | 15 分钟与 1 分钟趋势同向时才用激进系数 |
| 滑点压力测试 | STRESS_SLIPPAGE_ENABLED | False | 回测中叠加滑点做压力测试 |

---

## 五、数据与运行

### 5.1 数据

- **文件**：`history_159201_1m.csv`（与回测脚本同目录）
- **周期**：1 分钟 K 线
- **字段**：open, high, low, close，索引为时间

### 5.2 回测

```bash
cd /path/to/miniqmt
source .venv/bin/activate
python mac_backtest_159201.py
```

### 5.3 实盘信号（Mac 看板）

- **脚本**：`mac_dashboard.py`
- **输入**：`shared_quote.json`（需含 `price`、`history` 的 OHLC，建议至少约 65 根 K 线）
- **输出**：`order_signal.json`（code、direction、price、shares、timestamp）
- **状态**：`dashboard_state.json` 持久化 last_buy_price、hold_layers、total_cost、hold_t0_volume  
- 看板与回测使用**同一套参数**（含阶梯权重与风控），逻辑一致。

---

## 六、回测表现参考（万一佣金 + 新逻辑）

*随数据区间变化；万一佣金 + 层数加成步长 + 动态冷静期 + 单笔止盈。*

| 指标 | 典型数值 |
|------|----------|
| 成交总数 | 约 324（买+卖） |
| 打满(9层)次数 | 约 11 |
| 打满且完成平仓轮次 | 约 7 轮 |
| ATR 熔断未加仓 K 线数 | 约 19 |
| Alpha 套利净收益 | 约 31,000+ 元（已扣万一手续费） |
| Beta 持仓市值变动（30 万底仓） | 约 92,216 元 |
| 策略摊薄总收益 | 约 123,000+ 元 |
| Alpha 曲线最大回撤 | 视区间而定 |

*结果依赖历史数据与 1 分钟质量；实盘会有滑点与延迟。*

---

## 七、风险与注意

1. **T+0**：仅适用于支持当日卖出的标的，需确认 159201 规则。  
2. **滑点与手续费**：回测已扣万一，步长下限 0.12% 覆盖约 1 tick 滑点；实盘大单可能滑点更大。  
3. **趋势滞后**：MA60 斜率经 3 周期 EMA 平滑，仍有一定滞后。  
4. **风控参数**：熔断 2.0 倍、浮亏 1.5 万（针对 20 万流动仓）；层数加成与动态冷静期可减少子弹过快耗尽与高位接盘；超跌时缩短冷静期便于二次进场。  
5. **流动性**：ETF 流动性尚可，仍须避免大单冲击。

---

## 八、文件与参数速查

| 文件 | 作用 |
|------|------|
| `mac_backtest_159201.py` | 回测入口，含全部参数与风控、阶梯权重 |
| `mac_dashboard.py` | 实盘看板，与回测同参数、写信号与状态 |
| `history_159201_1m.csv` | 1 分钟 K 线（需自备） |
| `策略文档_159201.md` | 本文档 |

关键常数名：`BETA_CAPITAL`、`BATCH_MONEY`、`MAX_LAYERS`、`LAYER_WEIGHTS`、`ATR_GRID_FACTOR`、`GRID_STEP_FLOOR`、`LAYER_STEP_BONUS`、`TRAILING_ENABLED`、`SELL_PROFIT_THRESHOLD`、`COMMISSION_RATE`（万一 0.0001）、`ATR_CIRCUIT_BREAKER_RATIO`、`MAX_CYCLE_FLOAT_LOSS`、`COOLING_ENABLED`、`COOLING_BARS`、`COOLING_BARS_SHORT`、`RSI_COOLING_THRESHOLD`、`TIME_FILTER_ENABLED`。
