# miniqmt 实盘上线计划

基于工作区文档整理，供上线前准备与执行参考。

---

## 一、上线前准备清单

### 1.1 环境与依赖

| 端 | 要求 | 检查命令 |
|----|------|----------|
| **Mac** | Python 3.x、pandas、numpy、matplotlib、rich | `pip install -r requirements.txt` |
| **Windows** | Python 3.x、xtquant、QMT 已登录 | 确认 QMT 可正常下单 |
| **共享目录** | Mac 与 Windows 同步盘已配置 | 约定路径：`C:\Mac\Home\Documents\miniqmt`（Windows） |

### 1.2 数据与配置

- [ ] `history_159201_1m.csv` 已准备（回测用，可选）
- [ ] `bridge_producer.py` 与 `order_executor.py` 中 `SHARED_DIR`、`QMT_USERDATA_PATH`、`ACCOUNT_ID`、`ACCOUNT_TYPE` 已正确配置
- [ ] `mac_dashboard.py` 的 `_SCRIPT_DIR` 指向共享目录（与同步盘对齐）

---

## 二、离线测试阶段（必须全部通过）

按《离线测试流程.md》顺序执行，**不连 QMT、不实盘下单**。

### 阶段 1：回测自检

```bash
cd /path/to/miniqmt
python3 mac_backtest_159201.py
```

- [ ] 无报错，输出含成交笔数、Alpha、Beta、回撤
- [ ] 可与 `releases/v1.0.0` 历史结果对比（Alpha ~40,674 元，425 笔）

### 阶段 2：Mac 发信号离线验证

```bash
cd /path/to/miniqmt
export DASHBOARD_WORK_DIR="$(pwd)/test_offline"
python3 mac_dashboard.py
# 运行几秒后 Ctrl+C
```

- [ ] `test_offline/order_signal.json` 存在且为合法 JSON
- [ ] 含字段：`signal_id`、`code`、`direction`、`price`、`shares`（100 的整数倍）、`timestamp`、`reason`
- [ ] `signal_id` 格式：`BUY_159201.SZ_L1_xxxxxxxx` 或 `SELL_...`

### 阶段 3：执行器 dry-run

```bash
cd /path/to/miniqmt/test_offline
# 放入合法 order_signal.json 后
python3 test_executor_dryrun.py
```

- [ ] 合法信号：校验通过 → 写 `order_result.json` → 消费（`order_signal.json` 消失）
- [ ] `order_signal_done/order_signal_{signal_id}.done` 存在
- [ ] `executed_signals.json` 已记录 signal_id
- [ ] 同 signal_id 再放一份：幂等，只消费不重复执行

### 阶段 4：部分成交状态对齐

```bash
cd /path/to/miniqmt/test_offline
# 按《离线测试流程.md》准备 dashboard_state.json 与 order_result.json
python3 test_apply_partial_fill.py
```

- [ ] 买单部分成交：`positions` 正确、`pending_buy_shares` 已设
- [ ] 卖单部分成交：未卖部分写回 `positions`，`hold_layers`/`total_cost` 已更新

### 阶段 5：恢复与幂等

- [ ] 先状态后信号：崩溃后重启不会重复发单
- [ ] 执行器幂等：已执行 signal_id 不再下单
- [ ] 真实持仓同步：桥显示 0 持仓时，Mac 清空本地 positions

---

## 三、实盘部署步骤

### 3.1 部署顺序

```
1. 确认共享目录已同步（Mac ↔ Windows）
2. 启动 Windows：bridge_producer.py
3. 启动 Windows：order_executor.py
4. 启动 Mac：mac_dashboard.py
```

### 3.2 启动命令

**Windows（先桥接后执行器）**

```bash
cd C:\Mac\Home\Documents\miniqmt
python bridge_producer.py
# 另开终端
python order_executor.py
```

**模拟下单（不实际交易）**

首次上线建议先用模拟模式验证整条链路：

```bash
# Windows 端：设置环境变量后启动执行器
set ORDER_EXECUTOR_SIMULATE=1
python order_executor.py
```

- 不连 QMT、不实际下单
- 仍会校验信号、写 `order_result.json`、消费信号、记录 `executed_signals.json`
- 日志中会标注 `[SIMULATE] 模拟下单`

**Mac**

```bash
cd /path/to/miniqmt   # 与同步盘对齐的目录
python3 mac_dashboard.py
```

### 3.3 首次上线建议

- **小资金试跑**：先用少量资金验证整条链路
- **观察 1～2 个交易日**：确认信号格式、执行、持仓同步无误
- **检查日志**：`order_executor.log`、dashboard 控制台输出

---

## 四、上线后验证

| 验证项 | 方法 |
|--------|------|
| 行情更新 | `shared_quote.json` 的 `time` 字段持续更新 |
| 信号产生 | 满足条件时 `order_signal.json` 出现 |
| 信号消费 | 执行后 `order_signal.json` 消失，`order_signal_done/` 有对应 .done |
| 持仓同步 | Mac 看板 `hold_layers`、`positions` 与 QMT 实际持仓一致 |
| 幂等 | 同一 signal_id 不会重复下单 |

---

## 五、运维与恢复

### 5.1 进程守护建议

- **Mac**：launchd 或 supervisor 监控 `mac_dashboard.py`，崩溃自动拉起
- **Windows**：任务计划程序或类似工具监控 `bridge_producer.py`、`order_executor.py`

### 5.2 异常恢复（参考《实盘恢复与容错说明.md》）

| 场景 | 行为 |
|------|------|
| 行情超过 5 分钟未更新 | 自动暂停发单，标题栏提示「行情已过期」 |
| 桥显示 0 持仓、本地有持仓 | 以真实为准清空本地，避免重复卖 |
| 执行器重启 | 依赖 `executed_signals.json` 防重，已执行 signal_id 不再下单 |
| 静默期 | 不落盘，进程重启后自动解除 |

### 5.3 回滚方案

- 使用 `releases/v1.0.0/` 归档版本
- 回测校验：Alpha 40,674 元，425 笔，9 层均权

---

## 六、文档索引

| 文档 | 用途 |
|------|------|
| 开发文档_完整版.md | 架构、数据流、安全机制 |
| 离线测试流程.md | 五阶段离线测试详细步骤 |
| 实盘恢复与容错说明.md | 崩溃恢复、行情过期、持仓同步 |
| 策略文档_159201.md | 159201 策略参数与逻辑 |
| test_offline/README_offline_test.md | 测试目录使用说明 |

---

## 七、上线检查表（执行时勾选）

- [ ] 离线测试阶段 1～5 全部通过
- [ ] 共享目录路径与配置正确
- [ ] QMT 已登录、可下单
- [ ] 先启动 bridge_producer，再 order_executor，最后 mac_dashboard
- [ ] 首日观察信号、执行、持仓同步
- [ ] 进程守护已配置（可选）
