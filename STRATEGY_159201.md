# 159201 自由现金流 ETF — 策略说明文档

## 一、策略概述

本策略针对 **159201（华宝自由现金流 ETF）** 进行 **T+0 网格套利回测**：  
- **固定仓**：30 万长期持有，赚取 Beta（指数/标的涨跌收益）。  
- **流动仓**：20 万用于网格交易，赚取 Alpha（低买高卖套利，买卖量一致、每笔止盈全平）。

收益拆分为：**总收益 ≈ Alpha（流动仓套利）+ Beta（固定仓市值变动）**。

---

## 二、资金与仓位

| 项目 | 数值 | 说明 |
|------|------|------|
| 总资金 | 50 万 | 回测基准与 Alpha 曲线起点 |
| 固定仓 | 30 万 | 不参与网格，仅按期初→期末价格变动计算 Beta 收益 |
| 流动仓 | 20 万 | 参与网格买卖，按层数均分（见下） |

- **层数**：默认 9 层（`MAX_LAYERS=9`），每层金额 = 20万 / 9 ≈ 2.22 万。  
- **权重**：`LAYER_WEIGHTS` 为均权 `(1,1,1,1,1,1,1,1,1)`，可改为阶梯权重调节每层金额。  
- **买卖量一致**：每笔买入的股数，在该笔止盈时**一次性全部卖出**，不保留仓位、不转入固定仓。

---

## 三、网格与锚点

### 3.1 网格步长（买入触发）

- **基础步长**：`grid_step = max(GRID_STEP_FLOOR, ATR/价格 × ATR_GRID_FACTOR)`  
  - 步长下限：`GRID_STEP_FLOOR = 0.0008`（0.08%）  
  - 弹性系数：`ATR_GRID_FACTOR = 0.28`，ATR 周期 14。  
- **买入触发**：当前价 ≤ **锚点** × (1 − grid_step × BUY_STEP_FACTOR) 时，开新一层仓。  
- **锚点**：初始为第一根 K 线收盘价；每次**流动仓全部卖光**后，锚点更新为**该次卖出价**（last_buy_price = curr_p）。

即：从“上次卖出价”起，价格**向下跌一个步长**就加一层仓，形成多档抄底。

### 3.2 止盈（卖出触发）

- **单笔止盈**（`SELL_BY_LOT = True`）：按**笔**判断，每笔独立。  
- **触发条件**：当前价 ≥ 该笔**买入价** × (1 + SELL_PROFIT_THRESHOLD × SELL_THRESHOLD_FACTOR)。  
  - 止盈阈值：`SELL_PROFIT_THRESHOLD = 0.005`（0.5%）  
  - 涨多系数：`SELL_THRESHOLD_FACTOR = 1.4` → 实际约 0.7% 涨幅即止盈。  
- **卖出行为**：达到条件的该笔**整笔全平**（该笔股数全部卖出），不保留仓位。

### 3.3 跌少涨多（可选不对称）

- `BUY_STEP_FACTOR`：买入步长系数，1.0 = 与 grid_step 一致；<1 则更小跌幅就买（买得更密）。  
- `SELL_THRESHOLD_FACTOR`：止盈系数，1.0 = 对称；1.4 = 涨得更多才卖（更温和）。  
- 当前默认：买入 1.0、止盈 1.4，形成“跌少涨多”的温和不对称网格。

---

## 四、趋势与风控

### 4.1 趋势自适应（MA60 斜率）

- 1 分钟线计算 60 周期均线及其斜率。  
- **上升趋势**：网格步长 × 1.2、止盈系数 × 1.33、每层金额 × 0.7。  
- **下降趋势**：步长 × 1.0、止盈 × 0.83、每层金额 × 1.2。  

用于在趋势行情中略微调节网格密度与仓位。

### 4.2 ATR 熔断

- `ATR_CIRCUIT_BREAKER_ENABLED = True`：当 当前 ATR > 近期 60 根 K 线 ATR 均值 × 2.0 时，**本 K 线不新开仓**（仅暂停加仓，不强制平仓）。

### 4.3 单周期最大浮亏止损（默认关闭）

- `ENABLE_FLOAT_LOSS_STOP = False`：不启用。  
- 若开启：当流动仓单周期浮亏超过 `MAX_CYCLE_FLOAT_LOSS`（如 2.5 万）时，强制全平流动仓。

### 4.4 时间过滤（默认关闭）

- `TIME_FILTER_ENABLED = False`。  
- 若开启：9:30–9:45 不新开第一层；14:45 之后只卖不买。

---

## 五、手续费与滑点

- **佣金**：`COMMISSION_RATE = 0.0002`（0.02% 单边），ETF 无印花税。  
- **压力测试滑点**：`STRESS_SLIPPAGE_ENABLED = False`；若开启则叠加 0.05% 单边滑点。

---

## 六、收益与统计口径

### 6.1 Alpha（流动仓）

- **定义**：流动仓所有买卖的现金净流入（卖出收入 − 买入支出 − 手续费），即网格套利净收益。  
- **年化**：  
  - 按回测区间自然日：Alpha / 20万 / 年化天数。  
  - 按资金占用日：Alpha / 20万 × (365 / 有仓天数)，仅对有持仓的天数年化。

### 6.2 Beta（固定仓）

- **定义**：固定仓 30 万从**期初到期末**的市值变动：  
  `(期末价 - 期初价) × (30万 / 期初价)`。  
- 不参与网格，无转入转出，仅此一项。

### 6.3 总收益与回撤

- **策略摊薄总收益** = Alpha + Beta。  
- **Alpha 曲线最大回撤**：以「初始资金 50 万 + Alpha 曲线」做权益序列，按累计最大值计算回撤。

### 6.4 轮次统计

- **打满**：流动仓建满 9 层。  
- **打满且完成平仓**：从某次打满开始，到流动仓全部卖光为一轮；统计每轮最大浮亏与最终盈利（该轮 Alpha）。

---

## 七、运行方式

- **单次回测**（默认参数）：  
  `python mac_backtest_159201.py`  
- **层数扫描**：  
  `python mac_backtest_159201.py sweep`  
- **跌少涨多系数扫描**：  
  `python mac_backtest_159201.py asymmetric`  
- **步长下限扫描**：  
  `python mac_backtest_159201.py sweep_grid`  

数据文件：脚本同目录下 `history_159201_1m.csv`（1 分钟 K 线，需含 open/high/low/close，索引为时间）。

---

## 八、策略逻辑小结（买卖量一致）

1. **固定仓 30 万**：持有不动，只计 Beta。  
2. **流动仓 20 万**：按 9 层均分，每层约 2.22 万。  
3. **买入**：价格相对锚点下跌一个步长（经 ATR 与趋势调节）则加一层，记录该笔股数、成本、买入价。  
4. **卖出**：某笔当前价 ≥ 该笔买入价 × (1 + 止盈比例) 时，**该笔整笔全平**，买卖量一致。  
5. **锚点更新**：仅当流动仓**全部卖光**时，锚点更新为本次卖出价。  
6. **无“少卖多买”**：无部分止盈、无留仓、无转入固定仓；每笔都是“买多少、卖多少”。

以上即为当前 159201 回测的完整策略说明。
