# 512890 红利低波 ETF 网格套利策略文档

> 版本：基于 159201 的 ATR 动态网格 + 趋势自适应框架，针对低波动品种调参  
> 更新日期：2025-02

---

## 一、策略概述

本策略针对 **512890（红利低波 ETF）**，沿用 **159201 同套逻辑**：**ATR 动态网格 + 趋势自适应 + 层数加成步长 + 动态冷静期 + 单笔止盈**，并配备 **ATR 熔断** 与 **单周期最大浮亏止损**。因 512890 为**低波动**品种（跟踪中证红利低波指数，股息率高、波动率低），在参数上做**收紧网格、略降止盈阈值**等适配，以提高触发频率并控制单笔风险。

---

## 二、标的特性与 159201 对比

| 项目 | 159201 自由现金流 | 512890 红利低波 |
|------|-------------------|-----------------|
| 指数/风格 | 自由现金流因子 | 红利 + 低波动 |
| 波动特征 | 中等 | **较低** |
| 流动性 | 较好 | **规模大、成交活跃**（日均数亿） |
| 价格区间 | 约 1.0x | 约 1.0x |
| 策略适配 | 基准步长/止盈 | **步长略密、止盈略低**，其余框架一致 |

---

## 三、资金与仓位

| 参数 | 值 | 说明 |
|------|-----|------|
| 总资金（曲线基准） | 50 万 | 用于 Alpha 曲线与回撤计算 |
| 固定仓（Beta 底仓） | **30 万** | 与 159201 一致 |
| 流动仓（单轮套利） | **20 万** | 单轮 T+0 最大投入 |
| 最大补仓层数 | **9 层** | 可与 159201 一致；低波下打满概率较低 |
| 最小交易单位 | 100 股 | 按 100 股整数倍下单 |
| 手续费 | **0.01%（万一）** | 买卖均扣，ETF 无印花税 |

层权默认**均权**：`LAYER_WEIGHTS = (1,1,1,1,1,1,1,1,1)`，每层约 20万/9 ≈ 2.22 万 × 趋势 batch_factor。

---

## 四、核心逻辑（与 159201 一致）

### 4.1 执行顺序

每根 K 线：**有持仓时优先卖出与止损** → 再判断买入。

1. 有持仓 → 先判单周期最大浮亏止损 → 再单笔止盈。
2. 无持仓或未触发卖 → 满足买入条件且未熔断、未在冷静期 → 加仓（最多 9 层）。

### 4.2 买入条件

- **触发**：当前价 ≤ 上次买入价 × (1 - 网格步长 × 跌少系数)
- **网格步长**：`base_grid_step = max(GRID_STEP_FLOOR, (ATR14/当前价) × ATR_GRID_FACTOR)`，再按趋势调整；**最终** `grid_step = base_grid_step + (hold_layers × LAYER_STEP_BONUS)`
- **动态冷静期**：全平后禁止新开第一层；RSI<35 时 5 分钟，否则 15 分钟

### 4.3 卖出条件

- **单笔止盈**：每笔达到 止盈比例（基准阈值 × 涨多系数）即全平该笔
- **强制止损**：单周期浮亏 ≥ 设定金额 → 市价全平

### 4.4 趋势判断

- **指标**：1 分钟 MA60 的 5 周期变化率，3 周期 EMA 平滑
- **上升**：放宽网格、提高止盈、缩小每档金额  
- **下降**：收紧网格、降低止盈、放大每档金额  

---

## 五、512890 专用参数（相对 159201 的差异）

### 5.1 网格与止盈（低波适配，当前默认来自 tune combo2）

| 参数 | 159201 | 512890 默认 | 说明 |
|------|--------|-------------|------|
| ATR_GRID_FACTOR | 0.38 | **0.28** | tune 推荐更密网格 |
| GRID_STEP_FLOOR | 0.0012 (0.12%) | **0.0008 (0.08%)** | 步长下限 |
| LAYER_STEP_BONUS | 0.0001 | 0.0001 | 一致 |
| SELL_PROFIT_THRESHOLD | 0.005 (0.5%) | **0.004 (0.4%)** | 止盈阈值 |
| SELL_THRESHOLD_FACTOR | 1.4 | **1.35** | 涨多系数 |

### 5.2 趋势自适应系数（可与 159201 一致）

| 趋势 | 网格系数 | 止盈系数 | 仓位系数 |
|------|----------|----------|----------|
| 上升 | 1.2 | 1.33 | 0.7 |
| 下降 | 1.0 | 0.83 | 1.2 |
| 中性 | 1.0 | 1.0 | 1.0 |

### 5.3 风控与冷静期

| 参数 | 值 | 说明 |
|------|-----|------|
| ATR_CIRCUIT_BREAKER_RATIO | 2.0 | 与 159201 一致 |
| ATR_LOOKBACK | 60 | 与 159201 一致 |
| MAX_CYCLE_FLOAT_LOSS | 15,000 元 | 与 159201 一致（20 万流动仓） |
| COOLING_ENABLED | **False** | 默认 cooling_off：关冷静期，收益/回撤更均衡（见下） |
| COOLING_BARS / COOLING_BARS_SHORT | 15 / 5 | 若开启冷静期时生效 |
| RSI_COOLING_THRESHOLD | 35 | 与 159201 一致 |

### 5.4 cooling_off 配置说明（默认采用）

**含义**：在 **baseline 网格**（ATR_GRID_FACTOR=0.32、GRID_STEP_FLOOR=0.001）下 **仅关闭冷静期**，不压缩网格。

| 对比项 | baseline（开冷静期） | cooling_off（默认） | combo2（密网格+关冷静期） |
|--------|----------------------|---------------------|----------------------------|
| 年化笔数 | ~113 | **~216** | ~419 |
| Alpha | ~6.1k | **~11.7k** | ~15.9k |
| 最大回撤% | -0.98 | **-0.77**（最低） | -2.13 |
| 打满次数 | 1 | **2** | 15 |

**收益/风险特点**：比 baseline 多约一倍交易与 Alpha，回撤反而更小（全平后更快再开仓、资金利用更平滑）；比 combo2 交易频率与打满次数更低，回撤明显更小，适合偏稳健又希望适度提高收益的用法。当前脚本默认即为此配置。

---

## 六、数据与运行

### 6.1 数据

- **来源**：QMT 行情接口（`fetch_quote_512890.py` 拉取）
- **文件**：回测优先使用 `quote_512890_1min_5y.csv`（5 年），若无则用 `quote_512890_1min_3y.csv`
- **字段**：time, open, high, low, close, volume 等；回测需含 open/high/low/close，时间为索引

### 6.2 回测

```bash
cd /path/to/miniqmt
python mac_backtest_512890.py
```

### 6.3 实盘（若接入看板）

- 若将 512890 接入 `mac_dashboard`：需在 dashboard 与 `bridge_producer` 中增加标的或配置化，并采用本文档参数（或从配置文件读取）。
- 当前 159201 看板为单标的；512890 可单独一套 state/signal 或后续做多标的配置。

---

## 七、回测与实盘注意

1. **低波**：触发频率可能低于 159201，打满 9 层概率较小；回测可观察“想买但未触发”的 K 线占比。
2. **流动性**：512890 规模大、成交额高，滑点与冲击可沿用万一 + 约 1 tick 假设。
3. **T+0**：需确认 512890 支持当日卖出（ETF 一般支持）。
4. **参数扫描**：可在 `mac_backtest_512890.py` 中做 GRID_STEP_FLOOR、SELL_PROFIT_THRESHOLD、ATR_GRID_FACTOR 等小范围扫描，与 159201 对比夏普、回撤、打满次数。

---

## 八、调参实验（提升交易次数与 Alpha）

通过 `python mac_backtest_512890.py tune` 可一次性跑多组配置，对比**成交笔数**与 **Alpha**，综合得分兼顾回撤惩罚。

### 8.1 三个方向

| 方向 | 含义 | 典型 override |
|------|------|----------------|
| 压缩网格步长与 ATR 敏感度 | 步长更小、更易触发买入 | `grid_step_floor_override=0.0008`, `atr_grid_factor_override=0.28` |
| 缩短或移除动态冷静期 | 全平后更快再次进场 | `cooling_bars_override=5`, `cooling_bars_short_override=2` 或 `cooling_enabled_override=False` |
| 优化趋势自适应系数 | 下降更密买、上升略早卖 | `downtrend_grid_factor_override=0.88`, `uptrend_sell_factor_override=1.15` |

### 8.2 运行方式

```bash
cd /path/to/miniqmt
python mac_backtest_512890.py tune
```

输出表列：配置名、成交笔数、Alpha(元)、最大回撤%、占用年化%、打满次数、综合得分。得分 = 0.3×(成交笔数/10) + 0.5×(Alpha/1000) - 0.02×|回撤%|。

### 8.3 某次 tune 结果摘要（供参考）

| 配置 | 成交笔数 | Alpha(元) | 最大回撤% | 占用年化% | 打满 |
|------|----------|-----------|-----------|-----------|------|
| baseline | 114 | 6,449 | -0.98 | 43.59 | 1 |
| grid_tight | 130 | 7,513 | -1.08 | 50.78 | 2 |
| cooling_off | 214 | 11,853 | -0.77 | 30.04 | 2 |
| combo2（网格压缩+关冷静期） | 409 | 16,103 | -2.13 | 12.25 | 15 |

- **推荐默认**：combo2（网格步长 0.08%、ATR 系数 0.28、关闭冷静期）在 tune 中综合得分最高，成交与 Alpha 明显提升，回撤约 2.13%、打满 15 次；若偏保守可改用 **grid_tight** 或 **combo1**（保留短冷静期）。

---

## 九、文件与参数速查

| 文件 | 作用 |
|------|------|
| `策略文档_512890.md` | 本文档 |
| `mac_backtest_512890.py` | 512890 回测入口（同 159201 逻辑；默认已采用 tune 推荐 combo2） |
| `quote_512890_1min_5y.csv` / `quote_512890_1min_3y.csv` | QMT 拉取的 1 分钟数据（默认 5 年） |
| `fetch_quote_512890.py` | Windows 端从 QMT 拉取 512890 历史分钟数据（YEARS=5） |

关键常数名：`ATR_GRID_FACTOR`、`GRID_STEP_FLOOR`、`COOLING_ENABLED`、`COOLING_BARS`、`ATR_CIRCUIT_BREAKER_RATIO`、`MAX_CYCLE_FLOAT_LOSS`。
