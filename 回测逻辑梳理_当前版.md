# mac_backtest_159201.py 当前逻辑梳理

## 核心流程（单 K 线）

1. **取价与指标**：`curr_p`, `atr`, `slope`(MA60 斜率), `slope_15`(仅 MTF 开启时非 0)
2. **趋势与步长**：按 slope 正负应用 UPTREND/DOWNTREND 的 grid_step、sell_threshold、batch_factor；MTF 开启时若 1 分钟与 15 分钟不同向则保持中性
3. **网格步长**：`grid_step = base_grid_step + hold_layers * LAYER_STEP_BONUS`
4. **风控**：ATR 熔断时本 K 不新开层；可选单周期最大浮亏止损（当前关闭）
5. **时间过滤**：可选 9:30–9:45 不新开第一层、14:45 后只卖不买（当前关闭）
6. **卖出**（有持仓时）：
   - 若启用浮亏止损且浮亏 ≥ 阈值 → 强制全平、`_cycle_done_clear()`
   - 否则 **单笔止盈**：每笔 `curr_p >= buy_price * (1 + sell_eff)` 则卖出该笔，`sell_eff = sell_threshold * sell_threshold_factor`；最后一笔卖光后更新 `last_sell_bar`、周期统计，不调用 `_cycle_done_clear()`（仅清空 positions 相关状态）
7. **买入**：未打满且触发网格且未熔断且未时间过滤且未在冷静期 → 按 `part_money_list[hold_layers] * batch_factor` 下单，SELL_BY_LOT 时写入 `positions`

## 已去掉的冗余（本次整理）

- **移动止盈**：TRAILING_ENABLED 恒为 False，整块“移动止盈”分支及 `trailing_active`/`trailing_high`、`TRAILING_ENTRY_THRESHOLD`/`TRAILING_PULLBACK` 已删除
- **整体止盈**：SELL_BY_LOT 恒为 True，“整体收益达阈值一次性清仓”分支已删除
- **时间过滤**：合并为一个 if，仅在 TIME_FILTER_ENABLED 时计算 h,m 并判断

## 仍保留但当前未启用的开关

- **MTF_ENABLED**：False 时 slope_15=0，趋势仅看 MA60 斜率
- **COOLING_RSI_ENABLED**：False 时不做“RSI 回落至 50 以下才开仓”
- **TIME_FILTER_ENABLED** / **ENABLE_FLOAT_LOSS_STOP**：关闭，逻辑保留便于复开

## 默认运行与扫描

- `python mac_backtest_159201.py`：均权 9 层、单笔止盈 0.5%×涨多 1.4、动态冷静期，Alpha 约 40,674 元
- `sweep`：层数扫描；`asymmetric`：跌少涨多系数扫描；`sweep_grid`：步长下限扫描

*最后整理：去掉移动止盈/整体止盈分支及相关变量，时间过滤合并，回测结果不变。*
